#!/usr/bin/env ruby


pwd = ENV['PWD']

def gallery(images) 
 
  case images.length
  when 2
    width = 50
  when 3
    width = 33.33
  when 4
    width = 25
  when 5
    width = 20
  when 6
    width = 16.66
  when 7
    width = 14.28
  when 8
    width = 12.5
  when 9
    width = 11.11
  when 10
    width = 10
  when 11
    width = 9.09
  when 12
    width = 8.33
  else
    width = 100
  end

  css = "width:#{width}%; float: left"
  puts %Q{<a href="#{images.first}" target=_blank rel=noopener><img style="#{css}; clear: left" src="#{images.first}"></a>}
  images[1..-1].each do |image|
    puts %Q{<a href="#{image}" target=_blank rel=noopener><img style="#{css}" src="#{image}"></a>}
  end

end

def header(line)
  line.split(' ')[1..-1].join(' ')
end

puts %q{
<html>
<head>
<style>
  html { background-color: black; color: lightgray; }
  body { margin: 0; }   
  h1 { 
    width: 100%;
    float: left;
    clear: float;
    text-align:center; 
    vertical-align: middle;
    margin: 1em; 
    padding: 0; 
  }
  h3 { 
    font-size: 1.5em;
    width: 100%;
    float: left;
    clear: float;
    text-align:center; 
    vertical-align: middle;
  }

</style>
</head>
<body>
}

images = []
File.readlines(ARGV[0], chomp: true).each do |line|
  case line
  when /^$/ # empty lines
    gallery(images)unless images.empty?
    images = []
    puts ' ' 
  when /^###/
    puts "<h3>#{header(line)}</h3>"
  when /^##/
    puts "<h2>#{header(line)}</h2>"
  when /^#/
    puts "<h1>#{header(line)}</h1>"
  when /\-\-\-/
    next
  when /[0-9][0-9][0-9][0-9]\//
    images << "#{pwd}/#{line}"
  # paragraph
  else
    puts "<p>#{line}</p>"
  end
end
  
gallery(images)unless images.empty?

puts "
</body>
</html>
"
